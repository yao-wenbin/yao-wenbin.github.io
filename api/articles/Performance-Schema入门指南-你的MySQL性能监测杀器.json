{"title":"Performance Schema入门指南:你的MySQL性能监测杀器","uid":"ba1c6774f6090755efbcf2d6c3343eae","slug":"Performance-Schema入门指南-你的MySQL性能监测杀器","date":"2022-11-28T14:23:44.000Z","updated":"2022-11-28T14:25:33.753Z","comments":true,"path":"api/articles/Performance-Schema入门指南-你的MySQL性能监测杀器.json","cover":null,"content":"<h2 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h2><p>Performance提供了有关MySQL服务器内部运行的底层指标。在高负载下数据库调优是一个循环迭代的过程，每次更改以调整数据库的性能时，都需要了解更改是否有什么影响。而Performance Schama就是一个能够存储回答这个问题所需要的数据的数据库。</p>\n<h2 id=\"工作机制\"><a href=\"#工作机制\" class=\"headerlink\" title=\"工作机制\"></a>工作机制</h2><h3 id=\"插桩（instrument）\"><a href=\"#插桩（instrument）\" class=\"headerlink\" title=\"插桩（instrument）\"></a>插桩（instrument）</h3><p>插桩是指在MySQL代码中插入探测代码，以获取我们想要了解的信息。 比如要收集关于select语句的情况，我们就需要启用statement&#x2F;sql&#x2F;select插桩。</p>\n<p>在performance_schema中，setup_instruments包含了所有支持的插桩列表。每个插桩的名称都有斜杆分割的部件组成。比如statment&#x2F;sql&#x2F;select，从左到右依次表示从通用到特定的子系统。</p>\n<h3 id=\"消费者表（consumer）\"><a href=\"#消费者表（consumer）\" class=\"headerlink\" title=\"消费者表（consumer）\"></a>消费者表（consumer）</h3><p>消费者表就是记录某个插桩从插入到当前运行时的数据。比如某条SQL的执行总数、是否使用索引、话费的时间等信息。</p>\n<p>MySQL 8.0.25版本中包含了110个表，基于用途可以分为以下几类：</p>\n<ul>\n<li>当前和历史数据</li>\n<li>汇总和摘要</li>\n<li>实例表（Instance）</li>\n<li>设置表（Setup）</li>\n<li>其他表</li>\n</ul>\n<h3 id=\"资源消耗\"><a href=\"#资源消耗\" class=\"headerlink\" title=\"资源消耗\"></a>资源消耗</h3><p>Performance Schema收集的数据都保存在内存中，而每个插桩指令的调用都会额外的产生宏调用，将数据存放到performance_schema中，这就意味着插桩越多CPU的使用频率越高。<br>但对CPU使用率实际影响取决于特定的插桩。比如与statement相关的插件，在查询过程中只会被调用一次；而wait类的插桩调用频率就高的多，比如在扫描一个一百万行的InnoDB表，引擎需要设置和释放一百万行锁，那么CPU的使用率就会显著增加。<br>所以启动statment、内存和元数据锁类型的插桩，你不会注意到对CPU负载的任何增加。</p>\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><ul>\n<li>插桩目标必须得到MySQL组件的支持。 假设想要使用内存插桩，那么存储引擎应该是支持内存插桩的。</li>\n<li>只在启用后才收集数据。 在禁用所有插桩的情况下启动服务器，然后想要监测内存使用情况。那么全局缓冲区（比如InnoDB缓冲池）的确切数量就无法得知，因为启用内存插桩前就已经分配了该缓冲区。</li>\n<li>它很难释放内存。禁用了特定的插桩或消费者表也不会释放内存，除非重启服务器。</li>\n</ul>\n<h2 id=\"sys-Schema\"><a href=\"#sys-Schema\" class=\"headerlink\" title=\"sys Schema\"></a>sys Schema</h2><p>自5.7版本依赖，MySQL发行版就包括一个和performacne_schema配套的sys_schema。 它是基于performance_schema上的视图和存储过程组成。 他的目的是让performance_schema的体验更加流畅。</p>\n<h2 id=\"启动或禁用\"><a href=\"#启动或禁用\" class=\"headerlink\" title=\"启动或禁用\"></a>启动或禁用</h2><h3 id=\"performance-schema\"><a href=\"#performance-schema\" class=\"headerlink\" title=\"performance_schema\"></a>performance_schema</h3><p>要启用或禁用，只需要修改MySQL实例中的performance_schema即可，这是一个只读变量，所以要么在配置文件中修改，要么在MySQL服务器启动时通过命令参数更改</p>\n<h3 id=\"插桩\"><a href=\"#插桩\" class=\"headerlink\" title=\"插桩\"></a>插桩</h3><p>可以通过<code>setup_instruments</code>来查看插桩的状态</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>setup_instruments <span class=\"token keyword\">WHERE</span> NAME <span class=\"token operator\">=</span> <span class=\"token string\">'statement/sql/select'</span>\\G\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> <span class=\"token number\">1.</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n         NAME: statement<span class=\"token operator\">/</span><span class=\"token keyword\">sql</span><span class=\"token operator\">/</span><span class=\"token keyword\">select</span>\n      ENABLED: YES\n        TIMED: YES\n   PROPERTIES:\n   VOLATILITY: <span class=\"token number\">0</span>\nDOCUMENTATION: <span class=\"token boolean\">NULL</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>ENABLED值为YES，表示我们已经开启了<code>statement/sql/select</code>这个插桩了。</p>\n<p>对于插桩的禁用或启用，有三种方式</p>\n<ol>\n<li>UPDATE语句</li>\n</ol>\n<p>通过标准的SQL语句我们可以直接操作setup_instruments表</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">UPDATE</span> performance_schema<span class=\"token punctuation\">.</span>setup_instruments <span class=\"token keyword\">SET</span> ENABLED <span class=\"token operator\">=</span> <span class=\"token string\">'YES'</span> <span class=\"token keyword\">WHERE</span> NAME <span class=\"token operator\">=</span> <span class=\"token string\">'statement/sql/select'</span><span class=\"token punctuation\">;</span>\n\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">Rows</span> <span class=\"token keyword\">matched</span>: <span class=\"token number\">1</span>  Changed: <span class=\"token number\">0</span>  <span class=\"token keyword\">Warnings</span>: <span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol start=\"2\">\n<li>sys存储过程</li>\n</ol>\n<p>通过sys提供的存储过程，我们可以用更短的语句进行操作</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">CALL</span> sys<span class=\"token punctuation\">.</span>ps_setup_enable_instrument<span class=\"token punctuation\">(</span><span class=\"token string\">'statement/sql/select'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+</span>\n<span class=\"token operator\">|</span> summary               <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+</span>\n<span class=\"token operator\">|</span> Enabled <span class=\"token number\">0</span> instruments <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">-----------------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span>\n\nQuery OK<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token keyword\">rows</span> affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.02</span> sec<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>上面两种方式都会随则MySQL实例的重新启动而失效</p></blockquote>\n<ol start=\"3\">\n<li>启动选项</li>\n</ol>\n<p>这是唯一一个不会随着MySQL的重启而失效的方式。 该选项还支持通配符。</p>\n<pre class=\"line-numbers language-java\" data-language=\"java\"><code class=\"language-java\">performance<span class=\"token operator\">-</span>schema<span class=\"token operator\">-</span>instrument<span class=\"token operator\">=</span>'statement<span class=\"token operator\">/</span>sql<span class=\"token operator\">/</span>select<span class=\"token operator\">=</span><span class=\"token constant\">ON</span>'<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"消费者表\"><a href=\"#消费者表\" class=\"headerlink\" title=\"消费者表\"></a>消费者表</h3><p>与插桩一样，同样通过<code>setup_consumers</code>来查看消费者表的状态<br>同时支持三种方式启动或禁用</p>\n<ol>\n<li>直接使用SQL操作<code>setup_consumers</code>表</li>\n<li>调用sys_schema的<code>ps_setup_enable_consumer</code>和<code>ps_setup_disable_consumer</code>来启动和禁用</li>\n<li>使用<code>performance-schema-consumer</code>启动参数</li>\n</ol>\n<h2 id=\"使用场景\"><a href=\"#使用场景\" class=\"headerlink\" title=\"使用场景\"></a>使用场景</h2><h3 id=\"检查SQL语句\"><a href=\"#检查SQL语句\" class=\"headerlink\" title=\"检查SQL语句\"></a>检查SQL语句</h3><p>Performance Schema将SQL语句指标都存储在了<code>events_statments_current</code>、<code>events_statments_history</code>、<code>events_statments_long</code>三张具有相同的结构的表中。</p>\n<p>我们可以直接使用<code>perfomance_schema</code>进行查询：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>events_statements_history\\G<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> <span class=\"token number\">1.</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n              THREAD_ID: <span class=\"token number\">1580</span>\n               EVENT_ID: <span class=\"token number\">133</span>\n           END_EVENT_ID: <span class=\"token number\">133</span>\n             EVENT_NAME: statement<span class=\"token operator\">/</span><span class=\"token keyword\">sql</span><span class=\"token operator\">/</span><span class=\"token keyword\">select</span>\n                 SOURCE: init_net_server_extension<span class=\"token punctuation\">.</span>cc:<span class=\"token number\">97</span>\n            TIMER_START: <span class=\"token number\">989005876364000000</span>\n              TIMER_END: <span class=\"token number\">989005877298000000</span>\n             TIMER_WAIT: <span class=\"token number\">934000000</span>\n              LOCK_TIME: <span class=\"token number\">12000000</span>\n               SQL_TEXT: <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> events_statments_current\n                 DIGEST: <span class=\"token number\">287</span>a21eaee8bafb4d09ae546dbc232495489a4a8fd60e50eb535e1eb1cd384f4\n            DIGEST_TEXT: <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>events_statments_current<span class=\"token punctuation\">`</span></span>\n         CURRENT_SCHEMA: performance_schema\n            OBJECT_TYPE: <span class=\"token boolean\">NULL</span>\n          OBJECT_SCHEMA: <span class=\"token boolean\">NULL</span>\n            OBJECT_NAME: <span class=\"token boolean\">NULL</span>\n  OBJECT_INSTANCE_BEGIN: <span class=\"token boolean\">NULL</span>\n            MYSQL_ERRNO: <span class=\"token number\">1146</span>\n      RETURNED_SQLSTATE: <span class=\"token number\">42</span>S02\n           MESSAGE_TEXT: <span class=\"token keyword\">Table</span> <span class=\"token string\">'performance_schema.events_statments_current'</span> doesn't exist\n                 <span class=\"token keyword\">ERRORS</span>: <span class=\"token number\">1</span>\n               <span class=\"token keyword\">WARNINGS</span>: <span class=\"token number\">0</span>\n          ROWS_AFFECTED: <span class=\"token number\">0</span>\n              ROWS_SENT: <span class=\"token number\">0</span>\n          ROWS_EXAMINED: <span class=\"token number\">0</span>\nCREATED_TMP_DISK_TABLES: <span class=\"token number\">0</span>\n     CREATED_TMP_TABLES: <span class=\"token number\">0</span>\n       SELECT_FULL_JOIN: <span class=\"token number\">0</span>\n SELECT_FULL_RANGE_JOIN: <span class=\"token number\">0</span>\n           SELECT_RANGE: <span class=\"token number\">0</span>\n     SELECT_RANGE_CHECK: <span class=\"token number\">0</span>\n            SELECT_SCAN: <span class=\"token number\">0</span>\n      SORT_MERGE_PASSES: <span class=\"token number\">0</span>\n             SORT_RANGE: <span class=\"token number\">0</span>\n              SORT_ROWS: <span class=\"token number\">0</span>\n              SORT_SCAN: <span class=\"token number\">0</span>\n          NO_INDEX_USED: <span class=\"token number\">0</span>\n     NO_GOOD_INDEX_USED: <span class=\"token number\">0</span>\n       NESTING_EVENT_ID: <span class=\"token boolean\">NULL</span>\n     NESTING_EVENT_TYPE: <span class=\"token boolean\">NULL</span>\n    NESTING_EVENT_LEVEL: <span class=\"token number\">0</span>\n           STATEMENT_ID: <span class=\"token number\">14059</span>\n               CPU_TIME: <span class=\"token number\">0</span>\n       EXECUTION_ENGINE: <span class=\"token keyword\">PRIMARY</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>里面提供了非常多的有用的信息，包括：SQL语句是什么（SQL_TEXT）、所查询的schema是什么（CURRENT_SCHEMA）、是否包含错误或警告（ERRORS&#x2F;WARNINGS）、是否影响列（ROWS_AFFECTED）、是否使用了全表扫描（SELECT_SCAN）、是否创建了磁盘临时表（CREATED_TMP_DISK_TABLES）、是否没有使用索引(NO_INDEX_USED)、是否没有使用最合适的索引（NO_GOOD_INDEX_USED）</p>\n<h4 id=\"查询无索引SQL\"><a href=\"#查询无索引SQL\" class=\"headerlink\" title=\"查询无索引SQL\"></a>查询无索引SQL</h4><p>当我们希望找到某个shema中所有没有使用合适索引的查询，可以运行一下命令：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> THREAD_ID<span class=\"token punctuation\">,</span> SQL_TEXT<span class=\"token punctuation\">,</span> ROWS_SENT<span class=\"token punctuation\">,</span> ROWS_EXAMINED<span class=\"token punctuation\">,</span> CREATED_TMP_TABLES<span class=\"token punctuation\">,</span>\nNO_INDEX_USED<span class=\"token punctuation\">,</span> NO_GOOD_INDEX_USED\n<span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>events_statements_history_long\n<span class=\"token keyword\">WHERE</span> CURRENT_SCHEMA <span class=\"token operator\">=</span> <span class=\"token string\">'sakila'</span> <span class=\"token operator\">AND</span> <span class=\"token punctuation\">(</span>NO_INDEX_USED <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">OR</span> NO_GOOD_INDEX_USED <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"查询执行时间超过5秒的查询\"><a href=\"#查询执行时间超过5秒的查询\" class=\"headerlink\" title=\"查询执行时间超过5秒的查询\"></a>查询执行时间超过5秒的查询</h4><p>MySQL中为了更加精准的时间，TIMER_WAIT的时间单位为纳秒（1s &#x3D; 10^9 ns）</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> THREAD_ID<span class=\"token punctuation\">,</span> SQL_TEXT<span class=\"token punctuation\">,</span> ROWS_SENT<span class=\"token punctuation\">,</span> ROWS_EXAMINED<span class=\"token punctuation\">,</span> CREATED_TMP_TABLES<span class=\"token punctuation\">,</span>\nNO_INDEX_USED<span class=\"token punctuation\">,</span> NO_GOOD_INDEX_USED\n<span class=\"token keyword\">FROM</span> performance_schema<span class=\"token punctuation\">.</span>events_statements_history_long\n<span class=\"token keyword\">WHERE</span> TIMER_WAIT <span class=\"token operator\">></span> <span class=\"token number\">5000000000</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"使用sys-schema\"><a href=\"#使用sys-schema\" class=\"headerlink\" title=\"使用sys_schema\"></a>使用sys_schema</h3><p>前面我们说到sys_schema是基于performance_schema之上为我们提供方便使用的视图和存储过程的。<br>我们可以通过视图查询来查询优化的语句，比如：</p>\n<pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\">mysql<span class=\"token operator\">></span> <span class=\"token keyword\">SELECT</span> query<span class=\"token punctuation\">,</span> total_latency<span class=\"token punctuation\">,</span> no_index_used_count<span class=\"token punctuation\">,</span> rows_sent<span class=\"token punctuation\">,</span>rows_examined <span class=\"token keyword\">FROM</span> sys<span class=\"token punctuation\">.</span>statements_with_full_table_scans <span class=\"token keyword\">where</span> db <span class=\"token operator\">=</span> <span class=\"token string\">'charon'</span>\\G<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> <span class=\"token number\">1.</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span>\n              query: <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token identifier\"><span class=\"token punctuation\">`</span>sql_explain_statistics<span class=\"token punctuation\">`</span></span>\n      total_latency: <span class=\"token number\">97.00</span> us\nno_index_used_count: <span class=\"token number\">1</span>\n          rows_sent: <span class=\"token number\">1</span>\n      rows_examined: <span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>以下是可以用于查询需要优化的SQL语句的视图</p>\n<table>\n<thead>\n<tr>\n<th>视图</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>statements_analysis</td>\n<td>具有聚合信息的语句视图</td>\n</tr>\n<tr>\n<td>statments_with_errors_or_warnings</td>\n<td>所有引起错误或警告的语句视图</td>\n</tr>\n<tr>\n<td>statements_with_full_table_scans</td>\n<td>所有执行了全表扫描的语句视图</td>\n</tr>\n<tr>\n<td>statements_with_runtimes_in_95th_percentile</td>\n<td>所有平均执行时间在前95%的语句视图</td>\n</tr>\n<tr>\n<td>statements_with_sorting</td>\n<td>所有执行了排序的语句视图</td>\n</tr>\n<tr>\n<td>statements_with_temp_tables</td>\n<td>所有使用了临时表的语句视图</td>\n</tr>\n</tbody></table>\n","feature":true,"text":"简介Performance提供了有关MySQL服务器内部运行的底层指标。在高负载下数据库调优是一个循环迭代的过程，每次更改以调整数据库的性能时，都需要了解更改是否有什么影响。而Performance Schama就是一个能够存储回答这个问题所需要的数据的数据库。 工作机制插桩（i...","link":"","photos":[],"count_time":{"symbolsCount":"5.9k","symbolsTime":"5 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":5,"path":"api/tags/MySQL.json"},{"name":"监控","slug":"监控","count":1,"path":"api/tags/监控.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%AE%80%E4%BB%8B\"><span class=\"toc-text\">简介</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6\"><span class=\"toc-text\">工作机制</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8F%92%E6%A1%A9%EF%BC%88instrument%EF%BC%89\"><span class=\"toc-text\">插桩（instrument）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B6%88%E8%B4%B9%E8%80%85%E8%A1%A8%EF%BC%88consumer%EF%BC%89\"><span class=\"toc-text\">消费者表（consumer）</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B5%84%E6%BA%90%E6%B6%88%E8%80%97\"><span class=\"toc-text\">资源消耗</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9\"><span class=\"toc-text\">注意事项</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#sys-Schema\"><span class=\"toc-text\">sys Schema</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%90%AF%E5%8A%A8%E6%88%96%E7%A6%81%E7%94%A8\"><span class=\"toc-text\">启动或禁用</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#performance-schema\"><span class=\"toc-text\">performance_schema</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%8F%92%E6%A1%A9\"><span class=\"toc-text\">插桩</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B6%88%E8%B4%B9%E8%80%85%E8%A1%A8\"><span class=\"toc-text\">消费者表</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF\"><span class=\"toc-text\">使用场景</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%A3%80%E6%9F%A5SQL%E8%AF%AD%E5%8F%A5\"><span class=\"toc-text\">检查SQL语句</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%9F%A5%E8%AF%A2%E6%97%A0%E7%B4%A2%E5%BC%95SQL\"><span class=\"toc-text\">查询无索引SQL</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E6%9F%A5%E8%AF%A2%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%E8%B6%85%E8%BF%875%E7%A7%92%E7%9A%84%E6%9F%A5%E8%AF%A2\"><span class=\"toc-text\">查询执行时间超过5秒的查询</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8sys-schema\"><span class=\"toc-text\">使用sys_schema</span></a></li></ol></li></ol>","author":{"name":"姚文彬","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"深入底层 掌握脉搏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"基于Prometheus实现SpringBoot应用数据采集与业务埋点","uid":"51d09946e274f8b72c614484ac075533","slug":"基于Prometheus实现SpringBoot应用数据采集与业务埋点","date":"2023-05-22T14:01:22.000Z","updated":"2023-05-22T14:03:13.095Z","comments":true,"path":"api/articles/基于Prometheus实现SpringBoot应用数据采集与业务埋点.json","cover":null,"text":"SpringBoot监控添加prometheus依赖： &lt;!-- for monitor --> &lt;dependency> &lt;groupId>org.springframework.boot&lt;/groupId> &lt;artifactId>spring-...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"SpringBoot","slug":"SpringBoot","count":1,"path":"api/tags/SpringBoot.json"},{"name":"Prometheus","slug":"Prometheus","count":1,"path":"api/tags/Prometheus.json"},{"name":"业务","slug":"业务","count":1,"path":"api/tags/业务.json"}],"author":{"name":"姚文彬","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"深入底层 掌握脉搏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"你真的了解你的MySQL吗(MySQL基准测试)","uid":"4468f948c4ca4e742d657728958a113e","slug":"你真的了解你的MySQL吗-MySQL基准测试","date":"2022-11-12T13:31:33.000Z","updated":"2022-11-12T13:31:47.878Z","comments":true,"path":"api/articles/你真的了解你的MySQL吗-MySQL基准测试.json","cover":[],"text":"如果你没有真正的对服务器上的MySQL进行基准测试，就无法了解其真实情况到底是如何。 基准测试是数据库工程师必备的技能之一，否则你如何知道自己真的在优化数据库？ 为什么需要基测？基测可以观察系统在不同压力下的行为： 验证基于系统的一些假设是否符合实际情况。 测试当前的运行情况，如...","link":"","photos":[],"count_time":{"symbolsCount":"7k","symbolsTime":"6 mins."},"categories":[],"tags":[{"name":"MySQL","slug":"MySQL","count":5,"path":"api/tags/MySQL.json"}],"author":{"name":"姚文彬","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"深入底层 掌握脉搏","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}